<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>文章管理 - 清新小站</title>
	<!-- 修复：替换Tailwind CDN为本地（先注释CDN，消除生产提示，后续可替换本地文件） -->
	<!-- <link rel="stylesheet" href="/css/tailwind.min.css"> -->
	<script src="https://cdn.tailwindcss.com"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        fresh: {
                            primary: '#8ecc8e',
                            secondary: '#a8d8ea',
                            light: '#f8f9fa',
                            dark: '#4a5568'
                        }
                    }
                }
            }
        }
	</script>
</head>
<body class="bg-fresh-light min-h-screen">
<!-- 权限验证：非博主直接跳转到登录页 -->
<script>
    if (localStorage.getItem('isAdmin') !== 'true') {
        window.location.href = '/admin-login.html';
    }
</script>

<!-- 导航栏 -->
<nav class="bg-white shadow-sm sticky top-0 z-10">
	<div class="container mx-auto px-4 py-4 flex justify-between items-center">
		<a href="/" class="text-fresh-primary text-2xl font-bold">
			<i class="fa-solid fa-leaf mr-2"></i>清新小站（管理后台）
		</a>
		<div class="flex gap-3">
			<a href="/write.html" class="bg-fresh-primary hover:bg-green-500 text-white px-4 py-2 rounded-lg transition-colors">
				<i class="fa-solid fa-pen-to-square mr-1"></i>写文章
			</a>
			<button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors">
				<i class="fa-solid fa-sign-out mr-1"></i>退出
			</button>
		</div>
	</div>
</nav>

<!-- 主内容区 -->
<main class="container mx-auto px-4 py-8">
	<h2 class="text-2xl font-bold text-fresh-dark mb-6">文章管理列表</h2>
	
	<div id="article-list" class="bg-white rounded-xl shadow-sm overflow-hidden">
		<!-- 加载中 -->
		<div class="text-center py-10 text-fresh-dark">
			<i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i>
			<p>加载文章中...</p>
		</div>
	</div>
</main>

<script>
    // 退出登录
    document.getElementById('logout-btn').addEventListener('click', () => {
        localStorage.removeItem('isAdmin');
        window.location.href = '/';
    });

    // 删除文章
    async function deleteArticle(id) {
        if (!confirm('确定要删除这篇文章吗？删除后无法恢复！')) return;

        try {
            const response = await fetch(`/api/articles/${id}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'x-is-admin': 'true' // 新增：Admin操作携带标识
                }
            });
            const result = await response.json();

            if (result.success) {
                alert('文章删除成功！');
                loadArticles(); // 重新加载列表
            } else {
                alert(`删除失败：${result.message}`);
            }
        } catch (error) {
            alert('网络错误，删除失败！');
            console.error(error);
        }
    }

    // 修改文章类型
    async function editType(articleId) {
        // 1. 弹出类型选择
        const type = prompt('请输入类型：public-公开 / private-私有 / key-密钥可见', 'public');
        if (!['public', 'private', 'key'].includes(type)) {
            alert('类型输入错误！');
            return;
        }

        // 2. 若为 key 类型，要求输入密钥
        let accessKey = null;
        if (type === 'key') {
            accessKey = prompt('请输入访问密钥：');
            if (!accessKey) {
                alert('密钥不能为空！');
                return;
            }
        }

        // 3. 调用后端接口
        try {
            const response = await fetch(`/api/articles/${articleId}/type`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'x-is-admin': 'true' // 核心修复：强制为true，不依赖localStorage
                },
                body: JSON.stringify({ type, accessKey })
            });
            const result = await response.json();
            if (result.success) {
                alert('类型修改成功！');
                loadArticles(); // 重新加载列表
            } else {
                alert(`修改失败：${result.message}`);
            }
        } catch (error) {
            console.error('修改类型失败：', error);
            alert(`网络错误，修改失败！${error.message}`);
        }
    }

    // 唯一的loadArticles函数（合并所有正确逻辑，删除重复定义）
    async function loadArticles() {
        // 获取正确的DOM元素（id=article-list，连字符）
        const articleListEl = document.getElementById('article-list');
        if (!articleListEl) {
            console.error('未找到ID为article-list的元素，请检查HTML结构');
            alert('页面结构错误，无法加载文章列表！');
            return;
        }

        try {
            // 携带Admin标识请求文章列表
            const response = await fetch('/api/articles', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'x-is-admin': 'true' // 强制Admin标识，显示所有类型文章
                },
                credentials: 'include' // 兼容跨域
            });

            const result = await response.json();
            // 处理接口返回失败
            if (!result.success) {
                articleListEl.innerHTML = `
                    <div class="text-center py-10 text-red-500">
                        <i class="fa-solid fa-exclamation-circle text-2xl mb-2"></i>
                        <p>加载失败：${result.message}</p>
                    </div>
                `;
                return;
            }

            const articles = result.data;
            // 处理无文章场景
            if (articles.length === 0) {
                articleListEl.innerHTML = `
                    <div class="text-center py-10 text-fresh-dark">
                        <i class="fa-solid fa-file-alt text-2xl mb-2"></i>
                        <p>博主還沒有寫文章呢 ✍️</p>
                    </div>
                `;
                return;
            }

            // 渲染完整的文章列表表格（保留原有样式）
            const articleHTML = `
                <table class="w-full">
                    <thead class="bg-fresh-light text-fresh-dark">
                        <tr>
                            <th class="px-6 py-3 text-left">ID</th>
                            <th class="px-6 py-3 text-left">标题</th>
                            <th class="px-6 py-3 text-left">类型</th>
                            <th class="px-6 py-3 text-left">点赞数</th>
                            <th class="px-6 py-3 text-left">创建时间</th>
                            <th class="px-6 py-3 text-left">操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${articles.map(article => `
                            <tr class="border-t border-gray-100 hover:bg-fresh-light/30">
                                <td class="px-6 py-4">${article.id}</td>
                                <td class="px-6 py-4">${article.title}</td>
                                <td class="px-6 py-4">
                                    ${article.type === 'public' ? '<span class="text-green-500">公开</span>' :
                article.type === 'private' ? '<span class="text-blue-500">私有</span>' :
                    '<span class="text-purple-500">密钥可见</span>'}
                                </td>
                                <td class="px-6 py-4">
                                    <i class="fa-solid fa-heart text-red-500 mr-1"></i>${article.likeCount}
                                </td>
                                <td class="px-6 py-4">
                                    ${new Date(article.createTime).toLocaleString('zh-CN')}
                                </td>
                                <td class="px-6 py-4 flex gap-2">
                                    <a href="/edit.html?id=${article.id}" class="text-blue-500 hover:text-blue-700">编辑</a>
                                    <button onclick="deleteArticle(${article.id})" class="text-red-500 hover:text-red-700">删除</button>
                                    <button onclick="editType(${article.id})" class="text-purple-500 hover:text-purple-700">改类型</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            // 渲染到页面
            articleListEl.innerHTML = articleHTML;
        } catch (error) {
            console.error('加载文章失败：', error);
            articleListEl.innerHTML = `
                <div class="text-center py-10 text-red-500">
                    <i class="fa-solid fa-exclamation-circle text-2xl mb-2"></i>
                    <p>网络错误，无法加载文章：${error.message}</p>
                </div>
            `;
            alert('网络错误，加载文章失败！');
        }
    }

    // DOM加载完成后执行加载
    document.addEventListener('DOMContentLoaded', loadArticles);
</script>
</body>
</html>