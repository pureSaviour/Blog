<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>æ–‡ç« è¯¦æƒ… - æ¸…æ–°å°ç«™</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        fresh: {
                            primary: '#8ecc8e',
                            secondary: '#a8d8ea',
                            light: '#f8f9fa',
                            dark: '#4a5568'
                        }
                    }
                }
            }
        }
	</script>
</head>
<body class="bg-fresh-light min-h-screen">
<!-- å¯¼èˆªæ  -->
<nav class="bg-white shadow-sm sticky top-0 z-10">
	<div class="container mx-auto px-4 py-4 flex justify-between items-center">
		<a href="/" class="text-fresh-primary text-2xl font-bold">
			<i class="fa-solid fa-leaf mr-2"></i>æ¸…æ–°å°ç«™
		</a>
		<a href="/" class="text-fresh-dark hover:text-fresh-primary transition-colors">
			<i class="fa-solid fa-home mr-1"></i>è¿”å›é¦–é¡µ
		</a>
	</div>
</nav>

<!-- ä¸»å†…å®¹åŒº -->
<main class="container mx-auto px-4 py-8 max-w-4xl">
	<!-- æ–‡ç« è¯¦æƒ… -->
	<div id="article-detail" class="bg-white rounded-2xl shadow-sm p-8 mb-8">
		<!-- åŠ è½½ä¸­ -->
		<div class="text-center py-10 text-fresh-dark">
			<i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i>
			<p>åŠ è½½æ–‡ç« ä¸­...</p>
		</div>
	</div>
	
	<!-- è¯„è®ºåŒº -->
	<div class="bg-white rounded-2xl shadow-sm p-8">
		<h3 class="text-xl font-bold text-fresh-dark mb-6">
			<i class="fa-solid fa-comments mr-2"></i>è¯„è®ºåŒº
		</h3>
		
		<!-- è¯„è®ºæäº¤è¡¨å• -->
		<form id="comment-form" class="mb-8">
			<div class="mb-4">
				<label for="username" class="block text-fresh-dark mb-2 font-medium">ä½ çš„æ˜µç§°</label>
				<input type="text" id="username" name="username"
					   class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-fresh-primary/50 focus:border-fresh-primary transition-colors"
					   placeholder="è¾“å…¥æ˜µç§°...">
			</div>
			<div class="mb-4">
				<label for="comment-content" class="block text-fresh-dark mb-2 font-medium">è¯„è®ºå†…å®¹</label>
				<textarea id="comment-content" name="content" rows="4"
						  class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-fresh-primary/50 focus:border-fresh-primary transition-colors"
						  placeholder="å†™ä¸‹ä½ çš„æƒ³æ³•..."></textarea>
			</div>
			<button type="submit" class="bg-fresh-primary hover:bg-green-500 text-white px-4 py-2 rounded-lg transition-colors">
				<i class="fa-solid fa-paper-plane mr-1"></i>æäº¤è¯„è®º
			</button>
		</form>
		
		<!-- è¯„è®ºåˆ—è¡¨ -->
		<div id="comment-list">
			<div class="text-center py-6 text-fresh-dark">
				<i class="fa-solid fa-spinner fa-spin text-xl mb-2"></i>
				<p>åŠ è½½è¯„è®ºä¸­...</p>
			</div>
		</div>
	</div>
</main>

<script>
    // è·å–æ–‡ç« ID
    const urlParams = new URLSearchParams(window.location.search);
    const articleId = urlParams.get('id');
    if (!articleId) {
        alert('æ— æ•ˆçš„æ–‡ç« IDï¼');
        window.location.href = '/';
    }

    // åŠ è½½æ–‡ç« è¯¦æƒ…
    async function loadArticleDetail() {
        const articleDetailEl = document.getElementById('article-detail');
        try {
            const response = await fetch(`/api/articles/${articleId}`);
            const result = await response.json();

            if (!result.success) {
                articleDetailEl.innerHTML = `<div class="text-center py-10 text-red-500"><i class="fa-solid fa-exclamation-circle text-2xl mb-2"></i><p>åŠ è½½å¤±è´¥ï¼š${result.message}</p></div>`;
                return;
            }

            const article = result.data;
            // ========== æ–°å¢ï¼šå¯†é’¥éªŒè¯é€»è¾‘ ==========
            if (article.type === 'key') {
                // 1. æ£€æŸ¥ URL æ˜¯å¦æºå¸¦å¯†é’¥ï¼ˆéªŒè¯é€šè¿‡åä¼ é€’ï¼‰
                const urlParams = new URLSearchParams(window.location.search);
                const accessKey = urlParams.get('key');

                if (!accessKey) {
                    // 2. æ— å¯†é’¥ï¼šæ˜¾ç¤ºå¯†é’¥è¾“å…¥æ¡†
                    articleDetailEl.innerHTML = `
          <div class="text-center py-10">
            <h3 class="text-xl font-bold mb-4">è¯¥ç¬”è®°éœ€è¦å¯†é’¥è®¿é—®</h3>
            <input type="text" id="key-input" class="px-4 py-2 border border-gray-200 rounded-lg mb-2" placeholder="è¯·è¾“å…¥è®¿é—®å¯†é’¥">
            <button onclick="verifyKey(${articleId})" class="bg-fresh-primary text-white px-4 py-2 rounded-lg">éªŒè¯å¯†é’¥</button>
          </div>
        `;
                    return; // ç»ˆæ­¢åç»­æ¸²æŸ“
                } else {
                    // 3. æœ‰å¯†é’¥ï¼šéªŒè¯é€šè¿‡ï¼Œç»§ç»­æ¸²æŸ“
                    const verifyResponse = await fetch(`/api/articles/${articleId}/verify-key`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ accessKey })
                    });
                    const verifyResult = await verifyResponse.json();
                    if (!verifyResult.success) {
                        articleDetailEl.innerHTML = `<div class="text-center py-10 text-red-500"><p>å¯†é’¥éªŒè¯å¤±è´¥ï¼š${verifyResult.message}</p></div>`;
                        return;
                    }
                }
            }

            // ========== åŸæœ‰æ¸²æŸ“é€»è¾‘ï¼ˆå®Œå…¨ä¿ç•™ï¼‰ ==========
            articleDetailEl.innerHTML = `
      <h1 class="text-3xl font-bold text-fresh-dark mb-4">${article.title}</h1>
      <div class="flex justify-between items-center text-gray-500 mb-6">
        <div>
          <i class="fa-solid fa-clock mr-1"></i>
          ${new Date(article.createTime).toLocaleString('zh-CN')}
        </div>
        <div>
          <button id="like-btn" class="flex items-center gap-1 text-red-500 hover:text-red-600 transition-colors">
            <i class="fa-solid fa-heart"></i>
            <span>${article.likeCount}</span> ç‚¹èµ
          </button>
        </div>
      </div>
      ${article.cover ? `<img src="${article.cover}" alt="${article.title}" class="w-full h-64 object-cover rounded-lg mb-6">` : ''}
      <div class="text-gray-700 leading-relaxed whitespace-pre-line">${article.content}</div>
    `;

            // åŸæœ‰ç‚¹èµé€»è¾‘ï¼ˆå®Œå…¨ä¿ç•™ï¼‰
            document.getElementById('like-btn').addEventListener('click', async () => { /* åŸæœ‰ä»£ç  */ });
        } catch (error) {
            articleDetailEl.innerHTML = `<div class="text-center py-10 text-red-500"><i class="fa-solid fa-exclamation-circle text-2xl mb-2"></i><p>ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•åŠ è½½æ–‡ç« </p></div>`;
        }
    }

    // æ–°å¢ï¼šå¯†é’¥éªŒè¯å‡½æ•°
    async function verifyKey(articleId) {
        const accessKey = document.getElementById('key-input').value.trim();
        if (!accessKey) {
            alert('è¯·è¾“å…¥å¯†é’¥ï¼');
            return;
        }

        try {
            const response = await fetch(`/api/articles/${articleId}/verify-key`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ accessKey })
            });
            const result = await response.json();
            if (result.success) {
                // éªŒè¯é€šè¿‡ï¼šé‡æ–°åŠ è½½é¡µé¢å¹¶æºå¸¦å¯†é’¥
                window.location.href = `/detail.html?id=${articleId}&key=${accessKey}`;
            } else {
                alert(`å¯†é’¥é”™è¯¯ï¼š${result.message}`);
            }
        } catch (error) {
            alert('ç½‘ç»œé”™è¯¯ï¼ŒéªŒè¯å¤±è´¥ï¼');
        }
    }

    // åŠ è½½è¯„è®ºåˆ—è¡¨
    async function loadComments() {
        const commentListEl = document.getElementById('comment-list');
        try {
            const response = await fetch(`/api/articles/${articleId}/comments`);
            const result = await response.json();

            if (!result.success) {
                commentListEl.innerHTML = `<div class="text-center py-6 text-red-500"><i class="fa-solid fa-exclamation-circle text-xl mb-2"></i><p>åŠ è½½è¯„è®ºå¤±è´¥ï¼š${result.message}</p></div>`;
                return;
            }

            const comments = result.data;
            if (comments.length === 0) {
                commentListEl.innerHTML = `<div class="text-center py-6 text-fresh-dark"><i class="fa-solid fa-comment-slash text-xl mb-2"></i><p>æš‚æ— è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘å§ ğŸ’¬</p></div>`;
                return;
            }

            // æ¸²æŸ“è¯„è®º
            commentListEl.innerHTML = comments.map(comment => `
          <div class="border-b border-gray-100 py-4">
            <div class="flex justify-between items-center mb-2">
              <span class="font-medium text-fresh-dark">${comment.username}</span>
              <span class="text-xs text-gray-400">${new Date(comment.createTime).toLocaleString('zh-CN')}</span>
            </div>
            <p class="text-gray-600">${comment.content}</p>
          </div>
        `).join('');
        } catch (error) {
            commentListEl.innerHTML = `<div class="text-center py-6 text-red-500"><i class="fa-solid fa-exclamation-circle text-xl mb-2"></i><p>ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•åŠ è½½è¯„è®º</p></div>`;
            console.error(error);
        }
    }

    // æäº¤è¯„è®º
    document.getElementById('comment-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('username').value.trim();
        const content = document.getElementById('comment-content').value.trim();

        if (!username || !content) {
            alert('æ˜µç§°å’Œè¯„è®ºå†…å®¹ä¸èƒ½ä¸ºç©ºï¼');
            return;
        }

        try {
            const response = await fetch(`/api/articles/${articleId}/comments`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, content })
            });
            const result = await response.json();

            if (result.success) {
                alert('è¯„è®ºæäº¤æˆåŠŸï¼');
                document.getElementById('comment-form').reset();
                loadComments(); // é‡æ–°åŠ è½½è¯„è®º
            } else {
                alert(`æäº¤å¤±è´¥ï¼š${result.message}`);
            }
        } catch (error) {
            alert('ç½‘ç»œé”™è¯¯ï¼Œè¯„è®ºæäº¤å¤±è´¥ï¼');
            console.error(error);
        }
    });

    // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
    document.addEventListener('DOMContentLoaded', () => {
        loadArticleDetail();
        loadComments();
    });
</script>
</body>
</html>